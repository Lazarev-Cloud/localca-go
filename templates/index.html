<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalCA - Certificate Authority</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container content">
        <h1 class="mt-4 mb-4"><a href="/">LocalCA - Certificate Authority</a></h1>
        
        {{if .Error}}
        <div class="alert alert-danger">
            {{.Error}}
        </div>
        {{end}}

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h2>Create Certificate</h2>
                    </div>
                    <div class="card-body">
                        <form action="/" method="POST">
                            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                            <div class="form-group">
                                <label for="cn">Common Name (FQDN):</label>
                                <input type="text" class="form-control" id="cn" name="cn" required>
                            </div>
                            <div class="form-group">
                                <label for="additional_domains">Additional Domain Names (comma separated):</label>
                                <input type="text" class="form-control" id="additional_domains" name="additional_domains">
                                <small class="form-text text-muted">Optional: For SAN certificates with multiple domains</small>
                            </div>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="client" name="client">
                                <label class="form-check-label" for="client">Create client certificate and convert to .p12</label>
                            </div>
                            <div class="form-group" id="password_group" style="display:none;">
                                <label for="password">P12 Password:</label>
                                <input type="password" class="form-control" id="password" name="password">
                            </div>
                            <button type="submit" class="btn btn-primary">Create Certificate</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2>CA Certificate</h2>
                        <div>
                            <a href="/download/ca" class="btn btn-sm btn-primary">Download CA</a>
                            <a href="/download/crl" class="btn btn-sm btn-info ml-2">Download CRL</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <p><strong>CA Name:</strong> {{.CAName}}</p>
                        <p><strong>Organization:</strong> {{.Organization}}</p>
                        <p><strong>Country:</strong> {{.Country}}</p>
                        <p><strong>Expires:</strong> 
                            <span class="{{if .CAInfo.IsExpired}}text-danger{{else}}text-success{{end}}">
                                {{.CAInfo.ExpiryDate}}
                            </span>
                        </p>
                        <form action="/renew-ca" method="POST" onsubmit="return confirm('Are you sure you want to renew the CA certificate? This may require reinstalling the CA certificate on all clients.');">
                            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                            <button type="submit" class="btn btn-warning">Renew CA Certificate</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h2>Certificates</h2>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Expires</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{if .Certificates}}
                                        {{range .Certificates}}
                                        <tr class="{{if .IsRevoked}}table-danger{{else if .IsExpired}}table-danger{{else if .IsExpiringSoon}}table-warning{{end}}">
                                            <td><a href="/files?name={{.CommonName}}">{{.CommonName}}</a></td>
                                            <td>{{.ExpiryDate}} {{if .IsRevoked}}<span class="badge badge-danger">Revoked</span>{{end}}</td>
                                            <td>{{if .IsClient}}Client{{else}}Server{{end}}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    {{if not .IsRevoked}}
                                                    <button type="button" class="btn btn-primary renew-btn" data-name="{{.CommonName}}">Renew</button>
                                                    <button type="button" class="btn btn-warning revoke-btn" data-name="{{.CommonName}}">Revoke</button>
                                                    {{end}}
                                                    <button type="button" class="btn btn-danger delete-btn" data-name="{{.CommonName}}">Delete</button>
                                                </div>
                                            </td>
                                        </tr>
                                        {{end}}
                                    {{else}}
                                        <tr>
                                            <td colspan="4" class="text-center">No certificates found</td>
                                        </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 text-center">
                    <a href="/settings" class="btn btn-info">Email Notification Settings</a>
                </div>
                
                <div class="mt-4">
                    <div class="alert alert-warning">
                        <h4 class="alert-heading"><i class="fa fa-exclamation-triangle"></i> Warning</h4>
                        <p>This tool is for internal use only. Do not expose to the public internet.</p>
                        <p>Not suitable for production use. Not audited for security vulnerabilities.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the certificate <span id="delete-cert-name"></span>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Revoke Modal -->
    <div class="modal fade" id="revokeModal" tabindex="-1" role="dialog" aria-labelledby="revokeModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="revokeModalLabel">Confirm Revocation</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to revoke the certificate <span id="revoke-cert-name"></span>?</p>
                    <p class="alert alert-warning">
                        <i class="fa fa-exclamation-triangle"></i> 
                        Revoking a certificate will add it to the Certificate Revocation List (CRL).
                        Make sure to distribute the updated CRL to all systems that use certificates from this CA.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirm-revoke">Revoke</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Toggle password field based on client certificate checkbox
            $('#client').change(function() {
                if($(this).is(':checked')) {
                    $('#password_group').show();
                    $('#password').attr('required', true);
                } else {
                    $('#password_group').hide();
                    $('#password').attr('required', false);
                }
            });

            // Handle renew button
            $('.renew-btn').click(function() {
                const certName = $(this).data('name');
                if (confirm('Are you sure you want to renew the certificate ' + certName + '?')) {
                    $.post('/renew', {
                        name: certName,
                        csrf_token: '{{.CSRFToken}}'
                    })
                    .done(function(data) {
                        alert('Certificate renewed successfully');
                        location.reload();
                    })
                    .fail(function(xhr) {
                        alert('Failed to renew certificate: ' + xhr.responseJSON.message);
                    });
                }
            });

            // Handle delete button
            $('.delete-btn').click(function() {
                const certName = $(this).data('name');
                $('#delete-cert-name').text(certName);
                $('#deleteModal').modal('show');
            });

            // Handle revoke button
            $('.revoke-btn').click(function() {
                const certName = $(this).data('name');
                $('#revoke-cert-name').text(certName);
                $('#revokeModal').modal('show');
            });

            // Handle confirm delete
            $('#confirm-delete').click(function() {
                const certName = $('#delete-cert-name').text();
                $.post('/delete', {
                    name: certName,
                    csrf_token: '{{.CSRFToken}}'
                })
                .done(function(data) {
                    $('#deleteModal').modal('hide');
                    alert('Certificate deleted successfully');
                    location.reload();
                })
                .fail(function(xhr) {
                    $('#deleteModal').modal('hide');
                    alert('Failed to delete certificate: ' + xhr.responseJSON.message);
                });
            });

            // Handle confirm revoke
            $('#confirm-revoke').click(function() {
                const certName = $('#revoke-cert-name').text();
                $.post('/revoke', {
                    name: certName,
                    csrf_token: '{{.CSRFToken}}'
                })
                .done(function(data) {
                    $('#revokeModal').modal('hide');
                    alert('Certificate revoked successfully');
                    location.reload();
                })
                .fail(function(xhr) {
                    $('#revokeModal').modal('hide');
                    alert('Failed to revoke certificate: ' + xhr.responseJSON.message);
                });
            });
        });
    </script>
</body>
</html>