<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalCA - Email Settings</title>
    <link rel="stylesheet" href="/static/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/font-awesome/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/jquery-3.5.1.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container content">
        <h1 class="mt-4 mb-4"><a href="/">LocalCA</a> - Email Notification Settings</h1>
        
        {{if .Error}}
        <div class="alert alert-danger">
            {{.Error}}
        </div>
        {{end}}

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h2>Email Settings</h2>
                    </div>
                    <div class="card-body">
                        <form action="/settings" method="POST">
                            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                            
                            <div class="alert alert-info">
                                <i class="fa fa-info-circle"></i> Configure email settings to receive notifications when certificates are about to expire.
                            </div>
                            
                            <div class="form-group row">
                                <label for="email_to" class="col-sm-3 col-form-label">Send Notifications To:</label>
                                <div class="col-sm-9">
                                    <input type="email" class="form-control" id="email_to" name="email_to" value="{{.EmailTo}}" placeholder="recipient@example.com">
                                    <small class="form-text text-muted">Email address to receive certificate expiration notifications</small>
                                </div>
                            </div>
                            
                            <div class="form-group row">
                                <label for="smtp_server" class="col-sm-3 col-form-label">SMTP Server:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="smtp_server" name="smtp_server" value="{{.SMTPServer}}" placeholder="smtp.example.com">
                                    <small class="form-text text-muted">SMTP server hostname</small>
                                </div>
                            </div>
                            
                            <div class="form-group row">
                                <label for="smtp_port" class="col-sm-3 col-form-label">SMTP Port:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="smtp_port" name="smtp_port" value="{{.SMTPPort}}" placeholder="587">
                                    <small class="form-text text-muted">SMTP server port (usually 25, 465, or 587)</small>
                                </div>
                            </div>
                            
                            <div class="form-group row">
                                <label for="email_from" class="col-sm-3 col-form-label">From Address:</label>
                                <div class="col-sm-9">
                                    <input type="email" class="form-control" id="email_from" name="email_from" value="{{.EmailFrom}}" placeholder="localca@example.com">
                                    <small class="form-text text-muted">Email address to send from</small>
                                </div>
                            </div>
                            
                            <div class="form-group row">
                                <label for="smtp_user" class="col-sm-3 col-form-label">SMTP Username:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="smtp_user" name="smtp_user" value="{{.SMTPUser}}" placeholder="username">
                                    <small class="form-text text-muted">SMTP authentication username (if required)</small>
                                </div>
                            </div>
                            
                            <div class="form-group row">
                                <label for="smtp_pass" class="col-sm-3 col-form-label">SMTP Password:</label>
                                <div class="col-sm-9">
                                    <input type="password" class="form-control" id="smtp_pass" name="smtp_pass" value="{{.SMTPPass}}" placeholder="password">
                                    <small class="form-text text-muted">SMTP authentication password (if required)</small>
                                </div>
                            </div>
                            
                            <div class="form-group row">
                                <div class="col-sm-3">TLS Options:</div>
                                <div class="col-sm-9">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="use_tls" name="use_tls" {{if .UseTLS}}checked{{end}}>
                                        <label class="form-check-label" for="use_tls">
                                            Use TLS (connect with TLS encryption)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="use_starttls" name="use_starttls" {{if .UseStartTLS}}checked{{end}}>
                                        <label class="form-check-label" for="use_starttls">
                                            Use STARTTLS (upgrade connection to TLS)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group row">
                                <div class="col-sm-9 offset-sm-3">
                                    <button type="submit" class="btn btn-primary">Save Settings</button>
                                    <a href="/" class="btn btn-secondary ml-2">Cancel</a>
                                </div>
                            </div>
                        </form>
                        
                        <hr>
                        
                        <form id="test-email-form" class="mt-4">
                            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                            <div class="form-group row">
                                <label for="test_email" class="col-sm-3 col-form-label">Test Email:</label>
                                <div class="col-sm-6">
                                    <input type="email" class="form-control" id="test_email" name="test_email" placeholder="test@example.com">
                                </div>
                                <div class="col-sm-3">
                                    <button type="button" id="send-test-email" class="btn btn-info">Send Test Email</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        $(document).ready(function() {
            $('#send-test-email').click(function() {
                var testEmail = $('#test_email').val();
                if (!testEmail) {
                    alert('Please enter a test email address');
                    return;
                }
                
                // Disable button to prevent multiple clicks
                $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Sending...');
                
                $.post('/test-email', {
                    test_email: testEmail,
                    csrf_token: '{{.CSRFToken}}'
                })
                .done(function(data) {
                    if (data.success) {
                        alert('Test email sent successfully');
                    } else {
                        alert('Failed to send test email: ' + data.message);
                    }
                })
                .fail(function(xhr) {
                    alert('Failed to send test email: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
                })
                .always(function() {
                    $('#send-test-email').prop('disabled', false).html('Send Test Email');
                });
            });
        });
    </script>
</body>
</html>