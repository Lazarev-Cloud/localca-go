FROM golang:1.23.0-alpine AS go-builder

WORKDIR /app

# Install git and other dependencies
RUN apk add --no-cache git gcc musl-dev

# We'll mount the app directory as a volume
# This will let us build without copying files

FROM node:20-alpine AS node-builder

WORKDIR /app

# Install dependencies and tools
RUN apk add --no-cache jq bash

# We'll mount node_modules and app as volumes

FROM alpine:latest

WORKDIR /app

# Install necessary tools and Go 1.23.0
RUN apk add --no-cache bash nodejs npm git jq curl && \
    mkdir -p /usr/local/go && \
    curl -sSL https://dl.google.com/go/go1.23.0.linux-amd64.tar.gz | tar -C /usr/local -xz && \
    ln -s /usr/local/go/bin/go /usr/local/bin/go

ENV PATH="/usr/local/go/bin:${PATH}"
ENV GOPATH="/go"
ENV GOROOT="/usr/local/go"

# Copy the verification script
COPY scripts/verify-build.sh /app/scripts/verify-build.sh
RUN chmod +x /app/scripts/verify-build.sh

CMD ["/app/scripts/verify-build.sh"] 